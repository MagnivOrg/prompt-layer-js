var Ee=Object.defineProperty,Le=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var $e=Object.prototype.hasOwnProperty,We=Object.prototype.propertyIsEnumerable;var ee=(r,e)=>{if(e=Symbol[r])return e;throw Error("Symbol."+r+" is not defined")};var te=(r,e,t)=>e in r?Ee(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,y=(r,e)=>{for(var t in e||(e={}))$e.call(e,t)&&te(r,t,e[t]);if(Z)for(var t of Z(e))We.call(e,t)&&te(r,t,e[t]);return r},S=(r,e)=>Le(r,xe(e));var q=(r=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(r,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):r)(function(r){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var p=(r,e,t)=>new Promise((o,n)=>{var a=i=>{try{c(t.next(i))}catch(l){n(l)}},s=i=>{try{c(t.throw(i))}catch(l){n(l)}},c=i=>i.done?o(i.value):Promise.resolve(i.value).then(a,s);c((t=t.apply(r,e)).next())}),A=function(r,e){this[0]=r,this[1]=e},U=(r,e,t)=>{var o=(s,c,i,l)=>{try{var u=t[s](c),d=(c=u.value)instanceof A,P=u.done;Promise.resolve(d?c[0]:c).then(f=>d?o(s==="return"?s:"next",c[1]?{done:f.done,value:f.value}:f,i,l):i({value:f,done:P})).catch(f=>o("throw",f,i,l))}catch(f){l(f)}},n=s=>a[s]=c=>new Promise((i,l)=>o(s,c,i,l)),a={};return t=t.apply(r,e),a[Symbol.asyncIterator]=()=>a,n("next"),n("throw"),n("return"),a};var J=(r,e,t)=>(e=r[ee("asyncIterator")])?e.call(r):(r=r[ee("iterator")](),e={},t=(o,n)=>(n=r[o])&&(e[o]=a=>new Promise((s,c,i)=>(a=n.call(r,a),i=a.done,Promise.resolve(a.value).then(l=>s({value:l,done:i}),c)))),t("next"),t("return"),e);import ve from"ably";var _=process.env.URL_API_PROMPTLAYER||"https://api.promptlayer.com",re=(r,e)=>p(void 0,null,function*(){return e.request_response[Symbol.asyncIterator]!==void 0?Ke(r,e.request_response,e):yield oe(r,e)}),oe=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=yield t.json();if(t.status!==200&&R(o,"WARNING: While logging your request, PromptLayer experienced the following error:"),o&&e.return_pl_id)return[e.request_response,o.request_id]}catch(t){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${t}`)}return e.request_response}),ne=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/library-track-metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return R(o,"WARNING: While logging metadata to your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While logging metadata to your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),ae=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/library-track-score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return R(o,"WARNING: While scoring your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While scoring your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),se=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/library-track-prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return R(o,"WARNING: While associating your request with a prompt template, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a prompt template, PromptLayer experienced the following error: ${t}`),!1}return!0}),ie=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/track-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S(y({},e),{api_key:r}))}),o=yield t.json();if(t.status!==200)return R(o,"WARNING: While associating your request with a group, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a group, PromptLayer experienced the following error: ${t}`),!1}return!0}),ce=r=>p(void 0,null,function*(){try{let e=yield fetch(`${_}/create-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:r})}),t=yield e.json();return e.status!==200?(R(t,"WARNING: While creating a group PromptLayer had the following error"),!1):t.id}catch(e){return console.warn(`WARNING: While creating a group PromptLayer had the following error: ${e}`),!1}}),pe=(r,e,t)=>p(void 0,null,function*(){try{let o=new URL(`${_}/prompt-templates/${e}`),n=yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":r},body:JSON.stringify(t)}),a=yield n.json();return n.status!==200?(R(a,"WARNING: While fetching a prompt template PromptLayer had the following error"),null):(a.warning&&console.warn(`WARNING: While tracking your prompt PromptLayer had the following error: ${a.warning}`),a)}catch(o){return console.warn(`WARNING: While fetching a prompt template PromptLayer had the following error: ${o}`),null}}),le=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/rest/prompt-templates`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":r},body:JSON.stringify({prompt_template:y({},e),prompt_version:y({},e),release_labels:e.release_labels?e.release_labels:void 0})}),o=yield t.json();return t.status===400&&R(o,"WARNING: While publishing a prompt template PromptLayer had the following error"),o}catch(t){console.warn(`WARNING: While publishing a prompt template PromptLayer had the following error: ${t}`)}}),ue=(r,e)=>p(void 0,null,function*(){var t;try{let o=new URL(`${_}/prompt-templates`);Object.entries(e||{}).forEach(([s,c])=>o.searchParams.append(s,c.toString()));let n=yield fetch(o,{headers:{"Content-Type":"application/json","X-API-KEY":r}}),a=yield n.json();return n.status!==200?(R(a,"WARNING: While fetching all prompt templates PromptLayer had the following error"),null):(t=a.items)!=null?t:[]}catch(o){return console.warn(`WARNING: While fetching all prompt templates PromptLayer had the following error: ${o}`),null}}),me=i=>p(void 0,[i],function*({workflow_name:r,input_variables:e,metadata:t={},workflow_label_name:o=null,workflow_version_number:n=null,return_all_outputs:a=!1,api_key:s,timeout:c=12e4}){let l={input_variables:e,metadata:t,workflow_label_name:o,workflow_version_number:n,return_all_outputs:a},u={"X-API-KEY":s,"Content-Type":"application/json"};try{let d=yield fetch(`${_}/workflows/${encodeURIComponent(r)}/run`,{method:"POST",headers:u,body:JSON.stringify(l)});if(d.status!==201)return{success:!1,message:`Failed to run workflow: ${(yield d.json().catch(()=>({}))).error||d.statusText}`};let P=yield d.json();P.warning&&console.warn(`WARNING: ${P.warning}`);let f=P.workflow_version_execution_id;if(!f)return console.log("No execution ID returned from workflow run"),{success:!1,message:"Failed to run workflow"};let w=`workflow_updates:${f}`,h=(yield(yield fetch(`${_}/ws-token-request-library?capability=${w}`,{method:"POST",headers:u})).json()).token_details.token,g=new ve.Realtime({token:h});try{let m=yield Ge(g,w,c);return g.close(),m}finally{g.close()}}catch(d){throw console.error(`Failed to run workflow: ${d instanceof Error?d.message:d}`),d}});function Ge(r,e,t){return p(this,null,function*(){let o=r.channels.get(e);return new Promise((n,a)=>p(this,null,function*(){let s=i=>{if(i.name==="set_workflow_node_output"){let l=JSON.parse(i.data);l.status==="workflow_complete"&&(clearTimeout(c),o.unsubscribe("set_workflow_node_output",s),n(l.final_output))}},c=setTimeout(()=>{o.unsubscribe("set_workflow_node_output",s),a(new Error("Workflow execution did not complete properly (timeout)"))},t);try{yield o.subscribe("set_workflow_node_output",s)}catch(i){clearTimeout(c),a(i)}}))})}var x=r=>{var c,i,l,u,d,P,f,w,k;let e=null,t,o={id:"",choices:[],created:Date.now(),model:"",object:"chat.completion"},n=r.at(-1);if(!n)return o;let a;for(let b of r){if(b.choices.length===0)continue;let h=b.choices[0].delta;h.content&&(e=`${e||""}${h.content||""}`),h.function_call&&(t={name:`${t?t.name:""}${h.function_call.name||""}`,arguments:`${t?t.arguments:""}${h.function_call.arguments||""}`});let g=(c=h.tool_calls)==null?void 0:c[0];if(g){a=a||[];let m=a.at(-1);if(!m||g.id){a.push({id:g.id||"",type:g.type||"function",function:{name:((i=g.function)==null?void 0:i.name)||"",arguments:((l=g.function)==null?void 0:l.arguments)||""}});continue}m.function.name=`${m.function.name}${((u=g.function)==null?void 0:u.name)||""}`,m.function.arguments=`${m.function.arguments}${((d=g.function)==null?void 0:d.arguments)||""}`}}let s=r[0].choices.at(0);return o.choices.push({finish_reason:(P=s==null?void 0:s.finish_reason)!=null?P:"stop",index:(f=s==null?void 0:s.index)!=null?f:0,logprobs:(w=s==null?void 0:s.logprobs)!=null?w:null,message:{role:"assistant",content:e,function_call:t||void 0,tool_calls:a||void 0,refusal:(k=s==null?void 0:s.delta.refusal)!=null?k:null}}),o.id=n.id,o.model=n.model,o.created=n.created,o.system_fingerprint=n.system_fingerprint,o.usage=n.usage,o},D=r=>{let e={id:"",model:"",content:[],role:"assistant",type:"message",stop_reason:"stop_sequence",stop_sequence:null,usage:{input_tokens:0,output_tokens:0}};if(!r.at(-1))return e;let o="";for(let n of r)switch(n.type){case"message_start":{e=y({},n.message);break}case"content_block_delta":n.delta.type==="text_delta"&&(o=`${o}${n.delta.text}`);case"message_delta":"usage"in n&&(e.usage.output_tokens=n.usage.output_tokens),"stop_reason"in n.delta&&(e.stop_reason=n.delta.stop_reason);default:break}return e.content.push({type:"text",text:o}),e},je=(r,e="openai.chat.completions.create")=>{if("completion"in r[0])return r.reduce((t,o)=>S(y({},o),{completion:`${t.completion}${o.completion}`}),{});if(e==="anthropic.messages.create")return D(r);if("text"in r[0].choices[0]){let t="";for(let n of r)t=`${t}${n.choices[0].text}`;let o=structuredClone(r.at(-1));return o.choices[0].text=t,o}if("delta"in r[0].choices[0]){let t=x(r);return t.choices[0]=y(y({},t.choices[0]),t.choices[0].message),t}return""};function Ke(r,e,t){return U(this,null,function*(){let o=[];try{for(var s=J(e),c,i,l;c=!(i=yield new A(s.next())).done;c=!1){let u=i.value;yield t.return_pl_id?[u,null]:u,o.push(u)}}catch(i){l=[i]}finally{try{c&&(i=s.return)&&(yield new A(i.call(s)))}finally{if(l)throw l[0]}}let n=je(o,t.function_name),a=yield new A(oe(r,S(y({},t),{request_response:n,request_end_time:new Date().toISOString()})));if(a&&t.return_pl_id){let u=a[1];yield[o.at(-1),u]}})}var R=(r,e)=>{try{console.warn(`${e}: ${r.message}`)}catch(t){console.warn(`${e}: ${r}`)}},fe=r=>p(void 0,null,function*(){try{let e=yield fetch(`${_}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});return e.status!==200&&R(e,"WARNING: While logging your request, PromptLayer experienced the following error:"),e.json()}catch(e){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${e}`)}return{}}),Y=r=>{let e={id:"",choices:[{finish_reason:"stop",index:0,text:"",logprobs:null}],created:Date.now(),model:"",object:"text_completion"},t=r.at(-1);if(!t)return e;let o="";for(let n of r)n.choices.length>0&&n.choices[0].text&&(o=`${o}${n.choices[0].text}`);return e.choices[0].text=o,e.id=t.id,e.created=t.created,e.model=t.model,e.system_fingerprint=t.system_fingerprint,e.usage=t.usage,e},de=r=>{let e={completion:"",id:"",model:"",stop_reason:"",type:"completion"},t=r.at(-1);if(!t)return e;let o="";for(let n of r)o=`${o}${n.completion}`;return e.completion=o,e.id=t.id,e.model=t.model,e.stop_reason=t.stop_reason,e};function he(r,e,t){return U(this,null,function*(){let o={request_id:null,raw_response:null,prompt_blueprint:null},n=[];try{for(var c=J(r),i,l,u;i=!(l=yield new A(c.next())).done;i=!1){let d=l.value;n.push(d),o.raw_response=d,yield o}}catch(l){u=[l]}finally{try{i&&(l=c.return)&&(yield new A(l.call(c)))}finally{if(u)throw u[0]}}let a=t(n),s=yield new A(e({request_response:a}));o.request_id=s.request_id,o.prompt_blueprint=s.prompt_blueprint,yield o})}var Me=(r,e)=>p(void 0,null,function*(){return r.chat.completions.create(e)}),Ue=(r,e)=>p(void 0,null,function*(){return r.completions.create(e)}),ye={chat:Me,completion:Ue},ge=(r,e)=>p(void 0,null,function*(){let t=q("openai").default,o=new t({baseURL:e.baseURL}),n=ye[r.prompt_template.type];return n(o,e)}),_e=(r,e)=>p(void 0,null,function*(){let t=q("openai").AzureOpenAI,o=new t({endpoint:e.baseURL});e==null||delete e.baseURL;let n=ye[r.prompt_template.type];return n(o,e)}),Je=(r,e)=>p(void 0,null,function*(){return r.messages.create(e)}),De=(r,e)=>p(void 0,null,function*(){return r.completions.create(e)}),Ye={chat:Je,completion:De},we=(r,e)=>p(void 0,null,function*(){let t=q("@anthropic-ai/sdk").default,o=new t({baseURL:e.baseURL}),n=Ye[r.prompt_template.type];return n(o,e)}),Pe=(r,e)=>p(void 0,null,function*(){try{let t=yield fetch(`${_}/log-request`,{method:"POST",headers:{"X-API-KEY":r,"Content-Type":"application/json"},body:JSON.stringify(e)});return t.status!==201?(R(t,"WARNING: While logging your request PromptLayer had the following error"),null):t.json()}catch(t){return console.warn(`WARNING: While tracking your prompt PromptLayer had the following error: ${t}`),null}});var $=class{constructor(e){this.create=()=>ce(this.apiKey);this.apiKey=e}};import*as Te from"@opentelemetry/api";import{SimpleSpanProcessor as Fe}from"@opentelemetry/sdk-trace-base";import{NodeTracerProvider as ze}from"@opentelemetry/sdk-trace-node";import{SpanKind as E,SpanStatusCode as F}from"@opentelemetry/api";import{ExportResultCode as W}from"@opentelemetry/core";var z=class{constructor(e,t){this.apiKey=t||process.env.PROMPTLAYER_API_KEY,this.enableTracing=e,this.url=`${_}/spans-bulk`}attributesToObject(e){return e?Object.fromEntries(Object.entries(e)):{}}spanKindToString(e){return{[E.INTERNAL]:"SpanKind.INTERNAL",[E.SERVER]:"SpanKind.SERVER",[E.CLIENT]:"SpanKind.CLIENT",[E.PRODUCER]:"SpanKind.PRODUCER",[E.CONSUMER]:"SpanKind.CONSUMER"}[e]||"SpanKind.INTERNAL"}statusCodeToString(e){return{[F.ERROR]:"StatusCode.ERROR",[F.OK]:"StatusCode.OK",[F.UNSET]:"StatusCode.UNSET"}[e]||"StatusCode.UNSET"}toNanoseconds(e){return(BigInt(e[0])*BigInt(1e9)+BigInt(e[1])).toString()}export(e){if(!this.enableTracing)return Promise.resolve(W.SUCCESS);let t=e.map(o=>{var n;return{name:o.name,context:{trace_id:o.spanContext().traceId,span_id:o.spanContext().spanId,trace_state:((n=o.spanContext().traceState)==null?void 0:n.serialize())||""},kind:this.spanKindToString(o.kind),parent_id:o.parentSpanId||null,start_time:this.toNanoseconds(o.startTime),end_time:this.toNanoseconds(o.endTime),status:{status_code:this.statusCodeToString(o.status.code),description:o.status.message},attributes:this.attributesToObject(o.attributes),events:o.events.map(a=>({name:a.name,timestamp:this.toNanoseconds(a.time),attributes:this.attributesToObject(a.attributes)})),links:o.links.map(a=>({context:a.context,attributes:this.attributesToObject(a.attributes)})),resource:{attributes:S(y({},o.resource.attributes),{"service.name":"prompt-layer-js"}),schema_url:""}}});return fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":this.apiKey||""},body:JSON.stringify({spans:t})}).then(o=>o.ok?W.SUCCESS:(console.error(`Error exporting spans
HTTP error! status: ${o.status}`),W.FAILED)).catch(o=>(console.error("Error exporting spans:",o),W.FAILED))}shutdown(){return Promise.resolve()}},Re=z;var C=(r="promptlayer-tracer")=>Te.trace.getTracer(r),be=(r,e)=>{let t=new ze,o=new Re(r,e),n=new Fe(o);t.addSpanProcessor(n),t.register()};var Be=C(),B=(r,e,t="",o="openai")=>{let n={construct:(a,s)=>{let c=Reflect.construct(a,s);return Object.defineProperties(c,{function_name:{value:t,writable:!0},provider:{value:o}}),new Proxy(c,n)},get:(a,s,c)=>{let i=a[s],l=`${Reflect.get(a,"function_name")}.${s.toString()}`;return typeof i=="object"?(Object.defineProperties(i,{function_name:{value:l,writable:!0},provider:{value:o}}),new Proxy(i,n)):typeof i=="function"?(...u)=>{var k,b,h,g;let d=new Date().toISOString(),P=Reflect.get(a,"provider"),f=(k=u[0])==null?void 0:k.return_pl_id,w=(b=u[0])==null?void 0:b.pl_tags;return(h=u[0])==null||delete h.return_pl_id,(g=u[0])==null||delete g.pl_tags,Be.startActiveSpan(`${P}.${l}`,m=>p(void 0,null,function*(){try{m.setAttribute("function_input",JSON.stringify(u));let T=Reflect.apply(i,a,u),I=m.spanContext().spanId;return T instanceof Promise?new Promise((K,O)=>{T.then(N=>p(void 0,null,function*(){let L=yield re(r,{api_key:r,provider_type:P,function_name:l,request_start_time:d,request_end_time:new Date().toISOString(),request_response:N,kwargs:u[0],return_pl_id:f,tags:w,span_id:I});m.setAttribute("function_output",JSON.stringify(L)),m.setAttribute("response_status","success"),m.end(),K(L)})).catch(N=>{m.recordException(N),m.setAttribute("response_status","error"),m.end(),O(N)})}):(m.setAttribute("function_output",JSON.stringify(T)),m.setAttribute("response_status","success"),m.end(),T)}catch(T){throw m.recordException(T),m.setAttribute("response_status","error"),m.end(),T}}))}:Reflect.get(a,s,c)}};return new Proxy(e,n)};import*as v from"@opentelemetry/api";var ke=(r,e,t)=>function(...o){let n=C(),a=s=>{try{t&&Object.entries(t).forEach(([i,l])=>{s.setAttribute(i,l)}),s.setAttribute("function_input",JSON.stringify(o));let c=e(...o);return c instanceof Promise?c.then(i=>(s.setAttribute("function_output",JSON.stringify(i)),s.setStatus({code:v.SpanStatusCode.OK}),i)).catch(i=>{throw Se(s,i,o),i}).finally(()=>s.end()):(s.setAttribute("function_output",JSON.stringify(c)),s.setStatus({code:v.SpanStatusCode.OK}),s.end(),c)}catch(c){throw Se(s,c,o),c}};return n.startActiveSpan(r,a)},Se=(r,e,t)=>{r.setAttribute("function_input",JSON.stringify(t)),r.setStatus({code:v.SpanStatusCode.ERROR,message:e instanceof Error?e.message:"Unknown error"}),r.end()};var G=class{constructor(e){this.get=(e,t)=>pe(this.apiKey,e,t);this.publish=e=>le(this.apiKey,e);this.all=e=>ue(this.apiKey,e);this.apiKey=e}};var Xe=(r,e)=>{if(!(e.metadata instanceof Object))throw new Error("Please provide a dictionary of metadata.");for(let[t,o]of Object.entries(e.metadata))if(typeof t!="string"||typeof o!="string")throw new Error("Please provide a dictionary of metadata with key value pair of strings.");return ne(r,e)},He=(r,e)=>{if(typeof e.score!="number")throw new Error("Score must be a number");if(e.score<0||e.score>100)throw new Error("Score must be a number between 0 and 100.");return ae(r,e)},Ve=(r,e)=>{if(!(e.prompt_input_variables instanceof Object))throw new Error("Prompt template input variable dictionary not provided.");return se(r,e)},Qe=(r,e)=>ie(r,e),j=class{constructor(e){this.group=e=>Qe(this.apiKey,e);this.metadata=e=>Xe(this.apiKey,e);this.prompt=e=>Ve(this.apiKey,e);this.score=e=>He(this.apiKey,e);this.apiKey=e}};import*as Oe from"@opentelemetry/api";var Ze={openai:{chat:{function_name:"openai.chat.completions.create",stream_function:x},completion:{function_name:"openai.completions.create",stream_function:Y}},anthropic:{chat:{function_name:"anthropic.messages.create",stream_function:D},completion:{function_name:"anthropic.completions.create",stream_function:de}},"openai.azure":{chat:{function_name:"openai.AzureOpenAI.chat.completions.create",stream_function:x},completion:{function_name:"openai.AzureOpenAI.completions.create",stream_function:Y}}},et={openai:ge,anthropic:we,"openai.azure":_e},Ae=class{constructor({apiKey:e=process.env.PROMPTLAYER_API_KEY,enableTracing:t=!1}={}){if(e===void 0)throw new Error("PromptLayer API key not provided. Please set the PROMPTLAYER_API_KEY environment variable or pass the api_key parameter.");this.apiKey=e,this.enableTracing=t,this.templates=new G(e),this.group=new $(e),this.track=new j(e),this.wrapWithSpan=ke,t&&be(t,e)}get Anthropic(){try{let e=q("@anthropic-ai/sdk").default;return B(this.apiKey,e,"anthropic","anthropic")}catch(e){console.error("To use the Anthropic module, you must install the @anthropic-ai/sdk package.")}}get OpenAI(){try{let e=q("openai").default;return B(this.apiKey,e,"openai","openai")}catch(e){console.error("To use the OpenAI module, you must install the @openai/api package.")}}run(d){return p(this,arguments,function*({promptName:e,promptVersion:t,promptReleaseLabel:o,inputVariables:n,tags:a,metadata:s,groupId:c,modelParameterOverrides:i,stream:l=!1,skipLogging:u=!1}){return C().startActiveSpan("PromptLayer Run",f=>p(this,null,function*(){try{let w={promptName:e,promptVersion:t,promptReleaseLabel:o,inputVariables:n,tags:a,metadata:s,groupId:c,modelParameterOverrides:i,stream:l,skipLogging:u};f.setAttribute("function_input",JSON.stringify(w));let k=n,b={label:o,version:t,metadata_filters:s};n&&(b.input_variables=n);let h=yield this.templates.get(e,b);if(!h)throw new Error("Prompt not found");let g=h.prompt_template;if(!h.llm_kwargs)throw new Error(`Prompt '${e}' does not have any LLM kwargs associated with it.`);let m=h.metadata;if(!m)throw new Error(`Prompt '${e}' does not have any metadata associated with it.`);let T=m.model;if(!T)throw new Error(`Prompt '${e}' does not have a model parameters associated with it.`);let I=T.provider,K=new Date().toISOString(),O=y(y({},h.llm_kwargs),i||{}),N=Ze[I][g.type],L=N.function_name,Ne=N.stream_function,Ie=et[I],X=h.provider_base_url;X&&(O.baseURL=X.url),O.stream=l,l&&["openai","openai.azure"].includes(I)&&(O.stream_options={include_usage:!0});let M=yield Ie(h,O),H=Ce=>{if(u)return Promise.resolve({});let qe=new Date().toISOString();return fe(y({function_name:L,provider_type:I,args:[],kwargs:O,tags:a,request_start_time:K,request_end_time:qe,api_key:this.apiKey,metadata:s,prompt_id:h.id,prompt_version:h.version,prompt_input_variables:k,group_id:c,return_prompt_blueprint:!0,span_id:f.spanContext().spanId},Ce))};if(l)return he(M,H,Ne);let V=yield H({request_response:M}),Q={request_id:u?null:V.request_id,raw_response:M,prompt_blueprint:u?null:V.prompt_blueprint};return f.setAttribute("function_output",JSON.stringify(Q)),Q}catch(w){throw f.setStatus({code:Oe.SpanStatusCode.ERROR,message:w instanceof Error?w.message:"Unknown error"}),w}finally{f.end()}}))})}runWorkflow(c){return p(this,arguments,function*({workflowName:e,inputVariables:t={},metadata:o={},workflowLabelName:n=null,workflowVersion:a=null,returnAllOutputs:s=!1}){try{return yield me({workflow_name:e,input_variables:t,metadata:o,workflow_label_name:n,workflow_version_number:a,return_all_outputs:s,api_key:this.apiKey})}catch(i){throw i instanceof Error?(console.error("Error running workflow:",i.message),new Error(`Error running workflow: ${i.message}`)):(console.error("Unknown error running workflow:",i),new Error("Unknown error running workflow"))}})}logRequest(e){return p(this,null,function*(){return Pe(this.apiKey,e)})}};export{Ae as PromptLayer};
//# sourceMappingURL=index.js.map